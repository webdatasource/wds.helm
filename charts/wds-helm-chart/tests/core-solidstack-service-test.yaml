suite: test solidstack service
templates:
  - core-solidstack-service.yaml

tests:
  - it: should not render when mode != SingleService
    set:
      global.coreServices.mode: MultiService
    asserts:
      - hasDocuments:
          count: 0

  - it: should render with defaults
    set:
      global.coreServices.mode: SingleService
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[0].port
          value: 80
      - equal:
          path: spec.ports[0].targetPort
          value: http
      - equal:
          path: metadata.labels.app
          value: solidstack
      - equal:
          path: spec.selector.app
          value: solidstack

  - it: should merge global and service serviceExtraLabels
    set:
      global.coreServices.mode: SingleService
      global.serviceExtraLabels:
        globalLabel: g
        common: global
      coreServices.solidstack.serviceExtraLabelsOverride:
        serviceLabel: s
        common: service
    asserts:
      - equal:
          path: metadata.labels.globalLabel
          value: g
      - equal:
          path: metadata.labels.serviceLabel
          value: s
      - equal:
          path: metadata.labels.common
          value: service

  - it: should include shared chart labels and selector labels
    set:
      global.coreServices.mode: SingleService
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: wds-helm-chart
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: wds-helm-chart
      - equal:
          path: spec.selector["app.kubernetes.io/instance"]
          value: RELEASE-NAME
