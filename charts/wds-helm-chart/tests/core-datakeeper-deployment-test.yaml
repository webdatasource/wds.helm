suite: test core datakeeper deployment
templates:
  - core-datakeeper-deployment.yaml

tests:
  - it: should not render when mode != MultiService
    set:
      global.coreServices.mode: SingleService
    asserts:
      - hasDocuments:
          count: 0

  - it: should render when mode = MultiService
    set:
      global.coreServices.mode: MultiService
    asserts:
      - isKind:
          of: Deployment

  - it: should render with defaults
    set:
      global.coreServices.mode: MultiService
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.replicas
          value: 2
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^docker\.io/webdatasource/datakeeper:v\d+\.\d+\.\d+$
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: grpc-web-dk
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8082
      - equal:
          path: spec.template.spec.containers[0].ports[1].name
          value: grpc-web-rm
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 8083
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: IDEALER_ORIGIN
      - equal:
          path: spec.template.spec.containers[0].env[0].value
          value: http://idealer
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: DB_CONNECTION_STRING
      - equal:
          path: spec.template.spec.containers[0].env[2].name
          value: LICENSE_KEY
      - equal:
          path: spec.template.spec.containers[0].env[3].name
          value: MIN_LOG_LEVEL
      - equal:
          path: spec.template.spec.containers[0].env[3].value
          value: Information
      - notExists:
          path: spec.template.spec.containers[0].env[4]
      - notExists:
          path: spec.template.spec.nodeSelector
      - notExists:
          path: spec.template.spec.tolerations
      - notExists:
          path: spec.template.spec.affinity

  - it: should respect cache.connectionString
    set:
      global.coreServices.mode: MultiService
      global.coreServices.cache.connectionString: test-cache-connection-string
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: CACHE_CONNECTION_STRING
      - equal:
          path: spec.template.spec.containers[0].env[4].value
          value: test-cache-connection-string

  - it: should support mongodb.connectionStringSecretRef
    set:
      global.coreServices.mode: MultiService
      global.coreServices.databases.mongodb.connectionString: ""
      global.coreServices.databases.mongodb.connectionStringSecretRef:
        name: mongo-secret
        key: conn
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: DB_CONNECTION_STRING
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.name
          value: mongo-secret
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.key
          value: conn

  - it: should prefer mongodb.connectionString over secretRef when both set
    set:
      global.coreServices.mode: MultiService
      global.coreServices.databases.mongodb.connectionString: literal-mongo
      global.coreServices.databases.mongodb.connectionStringSecretRef:
        name: mongo-secret
        key: conn
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: DB_CONNECTION_STRING
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: literal-mongo
      - notExists:
          path: spec.template.spec.containers[0].env[1].valueFrom

  - it: should support cache.connectionStringSecretRef
    set:
      global.coreServices.mode: MultiService
      global.coreServices.cache.connectionString: ""
      global.coreServices.cache.connectionStringSecretRef:
        name: cache-secret
        key: conn
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: CACHE_CONNECTION_STRING
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.name
          value: cache-secret
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.key
          value: conn

  - it: should prefer cache.connectionString over secretRef when both set
    set:
      global.coreServices.mode: MultiService
      global.coreServices.cache.connectionString: literal-cache
      global.coreServices.cache.connectionStringSecretRef:
        name: cache-secret
        key: conn
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: CACHE_CONNECTION_STRING
      - equal:
          path: spec.template.spec.containers[0].env[4].value
          value: literal-cache
      - notExists:
          path: spec.template.spec.containers[0].env[4].valueFrom

  - it: should render image without registry when global.registry empty
    set:
      global.coreServices.mode: MultiService
      global.registry: ""
    asserts:
    - matchRegex:
        path: spec.template.spec.containers[0].image
        pattern: ^webdatasource/datakeeper:v\d+\.\d+\.\d+$

  - it: should render image with overrides (registry, name, tag, pullPolicy)
    set:
      global.coreServices.mode: MultiService
      global.registry: custom.registry
      coreServices.datakeeper.image.name: org/custom-datakeeper
      coreServices.datakeeper.image.tag: v9
      coreServices.datakeeper.image.pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom.registry/org/custom-datakeeper:v9
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  - it: should respect replicaCount override
    set:
      global.coreServices.mode: MultiService
      coreServices.datakeeper.replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should merge global and service deploymentExtraLabels
    set:
      global.coreServices.mode: MultiService
      global.deploymentExtraLabels:
        globalLabel: g
        common: global
      coreServices.datakeeper.deploymentExtraLabelsOverride:
        serviceLabel: s
        common: service
    asserts:
      - equal:
          path: metadata.labels.globalLabel
          value: g
      - equal:
          path: metadata.labels.serviceLabel
          value: s
      - equal:
          path: metadata.labels.common
          value: service

  - it: should apply global nodeSelector
    set:
      global.coreServices.mode: MultiService
      global.nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should allow nodeSelector override per service
    set:
      global.coreServices.mode: MultiService
      global.nodeSelector:
        disktype: ssd
      coreServices.datakeeper.nodeSelectorOverride:
        disktype: hdd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: hdd

  - it: should apply global tolerations
    set:
      global.coreServices.mode: MultiService
      global.tolerations:
        - key: dedicated
          operator: Equal
          value: datakeeper
          effect: NoSchedule
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0].key
          value: dedicated
      - equal:
          path: spec.template.spec.tolerations[0].operator
          value: Equal
      - equal:
          path: spec.template.spec.tolerations[0].value
          value: datakeeper
      - equal:
          path: spec.template.spec.tolerations[0].effect
          value: NoSchedule

  - it: should allow tolerations override per service
    set:
      global.coreServices.mode: MultiService
      global.tolerations:
        - key: dedicated
          operator: Equal
          value: datakeeper
          effect: NoSchedule
      coreServices.datakeeper.tolerationsOverride:
        - key: special
          operator: Exists
          effect: NoExecute
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0].key
          value: special
      - equal:
          path: spec.template.spec.tolerations[0].operator
          value: Exists
      - equal:
          path: spec.template.spec.tolerations[0].effect
          value: NoExecute

  - it: should apply global affinity
    set:
      global.coreServices.mode: MultiService
      global.affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: disktype
                    operator: In
                    values:
                      - ssd
    asserts:
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: disktype
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0]
          value: ssd

  - it: should allow affinity override per service
    set:
      global.coreServices.mode: MultiService
      global.affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: disktype
                    operator: In
                    values:
                      - ssd
      coreServices.datakeeper.affinityOverride:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - datakeeper
                topologyKey: kubernetes.io/hostname
    asserts:
      - notExists:
          path: spec.template.spec.affinity.nodeAffinity
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].weight
          value: 100
