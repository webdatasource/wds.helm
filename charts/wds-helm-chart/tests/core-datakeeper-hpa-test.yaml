suite: test core datakeeper HPA
templates:
  - core-datakeeper-hpa.yaml
tests:
  - it: should not render when mode != MultiService
    set:
      global.coreServices.mode: SingleService
      global.hpa.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when HPA disabled
    set:
      global.coreServices.mode: MultiService
      global.hpa.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render PDB when disable for the service
    set:
      global.coreServices.mode: MultiService
      global.hpa.enabled: true
      coreServices.datakeeper.hpa.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render with defaults
    set:
      global.coreServices.mode: MultiService
      global.hpa.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.minReplicas
          value: 1
      - equal:
          path: spec.maxReplicas
          value: 3
      - equal:
          path: spec.metrics[0].resource.name
          value: cpu
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 80

  - it: should allow service-level HPA override values
    set:
      global.coreServices.mode: MultiService
      global.hpa.enabled: true
      coreServices.datakeeper.hpa.minReplicas: 2
      coreServices.datakeeper.hpa.maxReplicas: 5
      coreServices.datakeeper.hpa.targetCPUUtilizationPercentage: 70
      coreServices.datakeeper.hpa.targetMemoryUtilizationPercentage: 60
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 5
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 70
      - equal:
          path: spec.metrics[1].resource.name
          value: memory
      - equal:
          path: spec.metrics[1].resource.target.averageUtilization
          value: 60

